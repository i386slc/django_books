# 2.10 Использование миграций

В гибкой разработке программного обеспечения **Agile** требования к проекту развиваются и время от времени обновляются в процессе разработки. Поскольку разработка происходит итеративно, вам придется вносить изменения в схему базы данных. Благодаря миграции Django вам не нужно вручную изменять таблицы и поля базы данных, так как большая часть этого выполняется автоматически с использованием интерфейса командной строки.

## Подготовка

Активируйте виртуальную среду в инструменте командной строки и измените активный каталог на каталог вашего проекта.

## Как это сделать...

Чтобы создать миграцию базы данных, выполните следующие действия:

1. Когда вы создаете модели в своем новом приложении **categories** или **ideas**, вам необходимо создать первоначальную миграцию, которая создаст таблицы базы данных для вашего приложения. Это можно сделать с помощью следующей команды:

```bash
(env)$ python manage.py makemigrations ideas
```

2\. В первый раз, когда вы хотите создать все таблицы для своего проекта, выполните следующую команду:

```bash
(env)$ python manage.py migrate
```

Запустите эту команду, если хотите выполнить новые миграции для всех своих приложений.

3\. Если вы хотите выполнить миграцию для определенного приложения, выполните следующую команду:

```bash
(env)$ python manage.py migrate ideas
```

4\. Если вы внесете некоторые изменения в схему базы данных, вам придется создать миграцию для этой схемы. Например, если мы добавим новое поле подзаголовка в модель идеи, мы можем создать миграцию с помощью следующей команды:

```bash
(env)$ python manage.py makemigrations --name=subtitle_added ideas
```

Однако поле `--name=subtitle_added` можно пропустить, потому что в большинстве случаев Django генерирует довольно понятные имена по умолчанию.

5\. Иногда может потребоваться массовое добавление или изменение данных в существующей схеме, что можно сделать с помощью переноса данных вместо переноса схемы. Чтобы создать миграцию данных, которая изменяет данные в таблице базы данных, мы можем использовать следующую команду:

```bash
(env)$ python manage.py makemigrations --name=populate_subtitle \
> --empty ideas
```

Параметр `--empty` указывает Django создать скелет миграции данных, который вы должны изменить, чтобы выполнить необходимые манипуляции с данными перед его применением. Для миграции данных рекомендуется задать имя.

6\. Чтобы вывести список всех доступных примененных и непримененных миграций, выполните следующую команду:

```bash
(env)$ python manage.py showmigrations
```

Примененные миграции будут перечислены с префиксом `[X]`. Непримененные будут перечислены с префиксом `[ ]`.

7\. Чтобы получить список всех доступных миграций для определенного приложения, выполните ту же команду, но передайте имя приложения следующим образом:

```bash
(env)$ python manage.py showmigrations ideas
```

## Как это работает...

Миграции Django — это файлы инструкций для механизма миграции базы данных. Файлы инструкций информируют нас о том, какие таблицы базы данных создавать или удалять, какие поля добавлять или удалять и какие данные вставлять, обновлять или удалять. Также они определяют, какие миграции зависят от каких других миграций.

В Django есть два типа миграции. Один из них — **миграция схемы**, а другой — **перенос данных**. Миграция схемы должна создаваться при добавлении новых моделей или добавлении или удалении полей. Миграцию данных следует использовать, когда вы хотите заполнить базу данных некоторыми значениями или массово удалить значения из базы данных. Миграции данных следует создавать с помощью команды в инструменте командной строки, а затем кодировать в файле миграции.

Миграции для каждого приложения сохраняются в их каталогах миграции. Первая миграция обычно называется **0001\_initial.py**, а другие миграции в нашем примере приложения будут называться **0002\_subtitle\_added.py** и **0003\_populate\_subtitle.py**. Каждая миграция получает префикс номера, который автоматически увеличивается. Для каждой выполненной миграции существует запись, которая сохраняется в таблице базы данных **django\_migrations**.

Можно выполнить миграцию туда и обратно, указав номер миграции, на которую мы хотим выполнить миграцию, как показано в следующей команде:

```bash
(env)$ python manage.py migrate ideas 0002
```

Чтобы отменить миграцию всех миграций приложения, включая начальную миграцию, выполните следующее:

```bash
(env)$ python manage.py migrate ideas zero
```

Отмена миграции требует, чтобы каждая миграция имела как прямое, так и обратное действие. В идеале, обратное действие точно отменяет изменения, сделанные прямым действием. Однако в некоторых случаях такое изменение будет необратимым, например, когда прямое действие удалит столбец из схемы, потому что оно уничтожит данные. В таком случае обратное действие может восстановить схему, но данные останутся потерянными навсегда, или обратного действия может вообще не быть.

{% hint style="info" %}
Не отправляйте свои миграции в систему управления версиями, пока не протестируете процесс прямой и обратной миграции и не будете уверены, что они будут хорошо работать в других разработках и средах общедоступных веб-сайтов.
{% endhint %}

## Дополнительно

Узнайте больше о написании миграции базы данных в официальном руководстве How To, которое можно [найти по адресу](https://docs.djangoproject.com/en/2.2/howto/writing-migrations/).

## Смотрите также

* Рецепт «[Работа с виртуальной средой](../1.-nachalo-raboty-s-django-3.0/1.3-rabota-s-virtualnoi-sredoi.md)» в главе 1 «[Начало работы с Django 3.0](../1.-nachalo-raboty-s-django-3.0/)».
* Рецепт «[Работа с контейнерами Docker для Django, Gunicorn, Nginx и PostgreSQL](../1.-nachalo-raboty-s-django-3.0/1.17-rabota-s-konteinerami-docker-dlya-django-gunicorn-nginx-i-postgresql.md)» в главе 1 «[Начало работы с Django 3.0](../1.-nachalo-raboty-s-django-3.0/)».
* Рецепт [обработки зависимостей проекта с помощью pip](../1.-nachalo-raboty-s-django-3.0/1.5-obrabotka-zavisimostei-proekta-s-pomoshyu-pip.md) в главе 1 «[Начало работы с Django 3.0](../1.-nachalo-raboty-s-django-3.0/)».
* Рецепт «[Включение внешних зависимостей в ваш проект](../1.-nachalo-raboty-s-django-3.0/1.9-vklyuchenie-vneshnikh-zavisimostei-v-vash-proekt.md)» в главе 1 «[Начало работы с Django 3.0](../1.-nachalo-raboty-s-django-3.0/)».
* Рецепт «[Изменение внешнего ключа на поле «многие ко многим](2.11-izmenenie-vneshnego-klyucha-na-pole-mnogie-ko-mnogim.md)»

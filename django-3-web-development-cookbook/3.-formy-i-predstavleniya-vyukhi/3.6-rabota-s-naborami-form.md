# 3.6 Работа с наборами форм

Помимо обычных или модельных форм, в Django есть концепция наборов форм. Это наборы форм одного типа, которые позволяют нам создавать или изменять сразу несколько экземпляров. Наборы форм Django могут быть обогащены **JavaScript**, что позволяет нам динамически добавлять их на страницу. Именно над этим мы и будем работать в этом рецепте. Мы расширим форму идей, чтобы можно было добавлять переводы на разные языки на одной странице.

## Подготовка

Давайте продолжим работу над **IdeaForm** из предыдущего рецепта «[Создание макета формы с помощью django-crispy-forms](3.5-sozdanie-maketa-formy-s-pomoshyu-django-crispy-forms.md)».

## Как это сделать...

Следуй этим шагам:

1. Давайте изменим макет формы для **IdeaForm**:

```python
# myproject/apps/ideas/forms.py
from django import forms
from django.utils.translation import ugettext_lazy as _
from django.conf import settings
from django.db import models

from crispy_forms import bootstrap, helper, layout

from .models import Idea

class IdeaForm(forms.ModelForm):
    class Meta:
        model = Idea
        exclude = ["author"]

    def __init__(self, request, *args, **kwargs):
        self.request = request
        super().__init__(*args, **kwargs)

        self.fields["categories"].widget = forms.CheckboxSelectMultiple()

        title_field = layout.Field(
            "title", css_class="input-block-level"
        )
        content_field = layout.Field(
            "content", css_class="input-block-level", rows="3"
        )
        main_fieldset = layout.Fieldset(
            _("Main data"), title_field, content_field
        )

        picture_field = layout.Field(
            "picture", css_class="input-block-level"
        )
        format_html = layout.HTML(
            """{% raw %}
{% include "ideas/includes/picture_guidelines.html" %}"""
        )

        picture_fieldset = layout.Fieldset(
            _("Picture"),
            picture_field,
            format_html,
            title=_("Image upload"),
            css_id="picture_fieldset",
        )

        categories_field = layout.Field(
            "categories", css_class="input-block-level"
        )
        categories_fieldset = layout.Fieldset(
            _("Categories"), categories_field,
            css_id="categories_fieldset"
        )
        
        inline_translations = layout.HTML(
            """{% include "ideas/forms/translations.html" %}
{% endraw %}"""
        )

        submit_button = layout.Submit("save", _("Save"))
        actions = bootstrap.FormActions(submit_button)

        self.helper = helper.FormHelper()
        self.helper.form_action = self.request.path
        self.helper.form_method = "POST"
        self.helper.layout = layout.Layout(
            main_fieldset,
            inline_translations,
            picture_fieldset,
            categories_fieldset,
            actions,
        )

        def save(self, commit=True):
            instance = super().save(commit=False)
            instance.author = self.request.user
            if commit:
                instance.save()
                self.save_m2m()
            return instance
```

2\. Затем добавим форму **IdeaTranslationsForm** в конец того же файла:

```python
class IdeaTranslationsForm(forms.ModelForm):
    language = forms.ChoiceField(
        label=_("Language"),
        choices=settings.LANGUAGES_EXCEPT_THE_DEFAULT,
        required=True,
    )

    class Meta:
        model = IdeaTranslations
        exclude = ["idea"]

    def __init__(self, request, *args, **kwargs):
        self.request = request
        super().__init__(*args, **kwargs)

        id_field = layout.Field("id")
        language_field = layout.Field(
            "language", css_class="input-block-level"
        )
        title_field = layout.Field(
            "title", css_class="input-block-level"
        )
        content_field = layout.Field(
            "content", css_class="input-block-level", rows="3"
        )
        delete_field = layout.Field("DELETE")
        main_fieldset = layout.Fieldset(
            _("Main data"),
            id_field,
            language_field,
            title_field,
            content_field,
            delete_field,
        )

        self.helper = helper.FormHelper()
        self.helper.form_tag = False
        self.helper.disable_csrf = True
        self.helper.layout = layout.Layout(main_fieldset)
```

3\. Измените представление, чтобы добавить или изменить идеи, как показано ниже.

```python
# myproject/apps/ideas/views.py
from django.contrib.auth.decorators import login_required
from django.shortcuts import render, redirect, get_object_or_404
from django.forms import modelformset_factory
from django.conf import settings
from .forms import IdeaForm, IdeaTranslationsForm
from .models import Idea, IdeaTranslations
@login_required
def add_or_change_idea(request, pk=None):
idea = None
if pk:
idea = get_object_or_404(Idea, pk=pk)
IdeaTranslationsFormSet = modelformset_factory(
IdeaTranslations, form=IdeaTranslationsForm,
extra=0, can_delete=True
)
if request.method == "POST":
form = IdeaForm(request, data=request.POST,
files=request.FILES, instance=idea)
translations_formset = IdeaTranslationsFormSet(
queryset=IdeaTranslations.objects.filter(idea=idea),
data=request.POST,
files=request.FILES,
prefix="translations",
form_kwargs={"request": request},
)
if form.is_valid() and translations_formset.is_valid():
idea = form.save()
translations = translations_formset.save(
commit=False
)
for translation in translations:
translation.idea = idea
translation.save()
translations_formset.save_m2m()
for translation in
translations_formset.deleted_objects:
translation.delete()
return redirect("ideas:idea_detail", pk=idea.pk)
else:
form = IdeaForm(request, instance=idea)
translations_formset = IdeaTranslationsFormSet(
queryset=IdeaTranslations.objects.filter(idea=idea),
prefix="translations",
form_kwargs={"request": request},
)
context = {
"idea": idea,
"form": form,
"translations_formset": translations_formset
}
return render(request, "ideas/idea_form.html", context)
```
